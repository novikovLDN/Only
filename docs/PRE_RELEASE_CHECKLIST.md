# Pre-Release Checklist ‚Äî HabitBot

–í–∑–≥–ª—è–¥ CTO: —á—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ–¥ production –∏ –ø–µ—Ä–µ–¥ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ–º.

---

## 1. Pre-Release Checklist

### 1.1 –ö—Ä–∏—Ç–∏—á–Ω–æ (–±–ª–æ–∫–µ—Ä—ã —Ä–µ–ª–∏–∑–∞)

| # | –ü—Ä–æ–≤–µ—Ä–∫–∞ | –°—Ç–∞—Ç—É—Å | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|---|----------|--------|-------------|
| 1 | **Entry point** | ‚ö†Ô∏è | `run.py` ‚Üí `main_orchestrator`, `app.main` –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è. –£–±—Ä–∞—Ç—å –¥—É–±–ª–∏ –∏–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å |
| 2 | **Migrations vs init_db** | ‚ö†Ô∏è | `init_db()` –≤—ã–∑—ã–≤–∞–µ—Ç `create_all` ‚Äî –≤ prod –ª—É—á—à–µ `alembic upgrade head`. –ò–Ω–∞—á–µ –º–∏–≥—Ä–∞—Ü–∏–∏ 002, 003 –Ω–µ –ø—Ä–∏–º–µ–Ω—è—Ç—Å—è |
| 3 | **ALERT_CHAT_ID** | ‚úÖ | –í .env.example. –ë–µ–∑ –Ω–µ–≥–æ ‚Äî –∞–ª–µ—Ä—Ç—ã –Ω–µ —É—Ö–æ–¥—è—Ç |
| 4 | **Payments router** | ‚úÖ | –ü–æ–¥–∫–ª—é—á–µ–Ω –≤ bot_router (payments, fsm_common) |
| 5 | **Webhook endpoint** | ‚ö†Ô∏è | YooKassa/CryptoBot webhooks —Ç—Ä–µ–±—É—é—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–π HTTP endpoint. Long-polling –Ω–µ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç POST. –ù—É–∂–µ–Ω –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –∏–ª–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ health_server |
| 6 | **SENTRY_DSN** | ‚ö†Ô∏è | –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ –¥–ª—è prod |

### 1.2 –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

| # | –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | Prod | –ü—Ä–æ–≤–µ—Ä–∫–∞ |
|---|------------|------|----------|
| 1 | BOT_TOKEN | ‚úÖ | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ |
| 2 | DATABASE_URL | ‚úÖ | PostgreSQL –æ—Ç Railway |
| 3 | ADMIN_IDS | ‚úÖ | –°–ø–∏—Å–æ–∫ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é |
| 4 | ALERT_CHAT_ID | ‚úÖ | –î–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ |
| 5 | YOOKASSA_* | –ï—Å–ª–∏ –ø–ª–∞—Ç–∏–º | Shop ID, Secret, Webhook secret |
| 6 | CRYPTOBOT_TOKEN | –ï—Å–ª–∏ Crypto | –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ |
| 7 | PORT | Railway | –ê–≤—Ç–æ –æ—Ç Railway |
| 8 | TRIAL_DAYS, FREE_HABITS_LIMIT | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å | –î–µ—Ñ–æ–ª—Ç—ã —Ä–∞–∑—É–º–Ω—ã |

### 1.3 –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

| # | –ü—Ä–æ–≤–µ—Ä–∫–∞ | –î–µ–π—Å—Ç–≤–∏–µ |
|---|----------|----------|
| 1 | –ú–∏–≥—Ä–∞—Ü–∏–∏ | `alembic upgrade head` –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º |
| 2 | init_db | –£–±—Ä–∞—Ç—å create_all –≤ prod –∏–ª–∏ –≤—ã–∑—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ alembic –Ω–µ –ø—Ä–∏–º–µ–Ω—è–ª—Å—è |
| 3 | –ò–Ω–¥–µ–∫—Å—ã | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –¥–ª—è payments, habit_logs, analytics |

---

## 2. –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —Ä–∏—Å–∫–∏

### 2.1 –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ

| –†–∏—Å–∫ | –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å | –í–ª–∏—è–Ω–∏–µ | –ú–∏—Ç–∏–≥–∞—Ü–∏—è |
|------|-------------|---------|-----------|
| **–î–≤–∞ entry point** (main.py vs main_orchestrator) | –°—Ä–µ–¥–Ω—è—è | –ü—É—Ç–∞–Ω–∏—Ü–∞, –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ | –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å: —Ç–æ–ª—å–∫–æ run.py ‚Üí main_orchestrator |
| **FSM MemoryStorage** | –í—ã—Å–æ–∫–∞—è –ø—Ä–∏ 2+ –∏–Ω—Å—Ç–∞–Ω—Å–∞—Ö | –ü–æ—Ç–µ—Ä—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ —Ä–µ—Å—Ç–∞—Ä—Ç–µ, –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ø—Ä–∏ scale-out | RedisStorage –¥–ª—è prod |
| **Webhooks –±–µ–∑ endpoint** | –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è | –ü–ª–∞—Ç–µ–∂–∏ YooKassa/Crypto –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç | –î–æ–±–∞–≤–∏—Ç—å POST /webhook/yookassa –∏ —Ç.–¥. –≤ health_server –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å |
| **init_db create_all** | –°—Ä–µ–¥–Ω—è—è | –†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ —Å—Ö–µ–º—ã —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏ | –í prod: —Ç–æ–ª—å–∫–æ alembic, —É–±—Ä–∞—Ç—å create_all |
| **Throttling in-memory** | –°—Ä–µ–¥–Ω—è—è –ø—Ä–∏ 2+ –∏–Ω—Å—Ç–∞–Ω—Å–∞—Ö | –õ–∏–º–∏—Ç—ã –Ω–µ —Å—É–º–º–∞—Ä–Ω—ã–µ | Redis-based rate limit |

### 2.2 –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ

| –†–∏—Å–∫ | –ú–∏—Ç–∏–≥–∞—Ü–∏—è |
|------|-----------|
| Health check timeout 30s | –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ health –æ—Ç–≤–µ—á–∞–µ—Ç <5s |
| Scheduler JobStore ‚Äî –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ | max_instances=1, coalesce=True ‚Äî –æ–∫ |
| DB pool 5+10 | –ü—Ä–∏ 20+ RPS ‚Äî –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å, —É–≤–µ–ª–∏—á–∏—Ç—å –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ |
| Single point of failure | –û–¥–∏–Ω –∏–Ω—Å—Ç–∞–Ω—Å ‚Äî –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è —Å—Ç–∞—Ä—Ç–∞–ø–∞ |

### 2.3 –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

| –†–∏—Å–∫ | –ú–∏—Ç–∏–≥–∞—Ü–∏—è |
|------|-----------|
| YooKassa webhook ‚Äî –ø–æ–¥–¥–µ–ª–∫–∞ | verify_webhook (IP whitelist, signature) |
| ADMIN_IDS –≤ .env | –ù–µ –∫–æ–º–º–∏—Ç–∏—Ç—å .env |
| –°–µ–∫—Ä–µ—Ç—ã –≤ –ª–æ–≥–∞—Ö | –ù–µ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å token, secret_key |

---

## 3. –£–ª—É—á—à–µ–Ω–∏—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏

### 3.1 –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–¥ —Ä–µ–ª–∏–∑–æ–º

1. **Webhook endpoint –¥–ª—è –ø–ª–∞—Ç–µ–∂–µ–π**
   - –î–æ–±–∞–≤–∏—Ç—å –≤ aiohttp app: `POST /webhook/yookassa`, `POST /webhook/cryptobot`
   - –í—ã–∑—ã–≤–∞—Ç—å `webhook_processor.process_*` + PaymentService
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å URL –≤ –ª–∏—á–Ω—ã—Ö –∫–∞–±–∏–Ω–µ—Ç–∞—Ö YooKassa/CryptoBot

2. **Alembic –≤ –¥–µ–ø–ª–æ–µ**
   - –í Dockerfile/Railway: `alembic upgrade head` –ø–µ—Ä–µ–¥ `python run.py`
   - –ò–ª–∏ –≤ on_startup: –∑–∞–ø—É—Å–∫–∞—Ç—å alembic –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ

3. **Sentry**
   - `sentry_sdk.init(dsn=settings.sentry_dsn)` –≤ startup
   - –õ–æ–≤–∏—Ç—å –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è

### 3.2 –ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ

1. **init_db**: –≤ prod –Ω–µ –≤—ã–∑—ã–≤–∞—Ç—å create_all, —Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
2. **Graceful shutdown**: –¥–æ–∂–¥–∞—Ç—å—Å—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ–∫—É—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (aiogram polling —É–∂–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è)
3. **Structlog**: —É–∂–µ –≤ requirements ‚Äî –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å JSON-—Ñ–æ—Ä–º–∞—Ç –¥–ª—è –ª–æ–≥–æ–≤ –≤ prod

---

## 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –¥–æ–º–µ–Ω–∞–º

### 4.1 UX

| –ê—Å–ø–µ–∫—Ç | –°—Ç–∞—Ç—É—Å |
|--------|--------|
| –¢–µ–∫—Å—Ç—ã –≤ app/texts | ‚úÖ –ï–¥–∏–Ω—ã–π —Å—Ç–∏–ª—å |
| CTA –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö | ‚úÖ ¬´üí≥ –ë–∞–ª–∞–Ω—Å¬ª, ¬´‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–≤—ã—á–∫—É¬ª |
| FSM /cancel | ‚úÖ –ï—Å—Ç—å |
| Rate limit feedback | ‚ö†Ô∏è Throttling ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç (–º–æ–ª—á–∞–ª–∏–≤—ã–π skip). –î–æ–±–∞–≤–∏—Ç—å ¬´–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤¬ª |
| –û—à–∏–±–∫–∏ | ‚úÖ ERROR_GENERIC, HABIT_DONE_ERROR –∏ —Ç.–¥. |

### 4.2 Payments

| –ê—Å–ø–µ–∫—Ç | –°—Ç–∞—Ç—É—Å |
|--------|--------|
| Idempotency | ‚úÖ idempotency_key, provider_payment_id |
| Retry (create_payment) | ‚úÖ YooKassa, CryptoBot |
| Webhook verification | ‚úÖ verify_webhook –≤ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞—Ö |
| Autorenew | ‚úÖ SubscriptionRenewService |
| Webhook HTTP endpoint | ‚ùå –ù–µ—Ç ‚Äî –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è YooKassa/Crypto |

### 4.3 Scheduler

| –ê—Å–ø–µ–∫—Ç | –°—Ç–∞—Ç—É—Å |
|--------|--------|
| JobStore PostgreSQL | ‚úÖ –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å |
| Idempotent jobs | ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–µ—Ä–µ–¥ –¥–µ–π—Å—Ç–≤–∏–µ–º |
| coalesce, max_instances | ‚úÖ |
| Graceful shutdown | ‚úÖ shutdown(wait=True) |
| –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ | ‚úÖ job_execution_log |

### 4.4 Monitoring

| –ê—Å–ø–µ–∫—Ç | –°—Ç–∞—Ç—É—Å |
|--------|--------|
| Health /health | ‚úÖ bot, db, scheduler |
| Admin alerts | ‚úÖ CRITICAL 5min, WARNING 15min |
| Recovery notifications | ‚úÖ |
| System logs –≤ DB | ‚úÖ system_logs |
| Analytics cache | ‚úÖ analytics_metrics |

---

## 5. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ–º

### 5.1 –ü—Ä–∏ 2+ –∏–Ω—Å—Ç–∞–Ω—Å–∞—Ö

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°–µ–π—á–∞—Å | –ù—É–∂–Ω–æ |
|-----------|--------|-------|
| FSM storage | MemoryStorage | RedisStorage |
| Rate limit | In-memory dict | Redis |
| Scheduler | –û–¥–∏–Ω –Ω–∞ –∏–Ω—Å—Ç–∞–Ω—Å ‚Üí –¥—É–±–ª–∏ jobs | –û–¥–∏–Ω scheduler –Ω–∞ –∫–ª–∞—Å—Ç–µ—Ä (leader election) –∏–ª–∏ –≤—ã–Ω–µ—Å—Ç–∏ –≤ worker |

### 5.2 –ü—Ä–∏ —Ä–æ—Å—Ç–µ –Ω–∞–≥—Ä—É–∑–∫–∏

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –î–µ–π—Å—Ç–≤–∏–µ |
|-----------|----------|
| DB pool | –£–≤–µ–ª–∏—á–∏—Ç—å pool_size, max_overflow |
| Long-polling | –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å webhook –¥–ª—è –±–æ—Ç–∞ (–º–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∏) |
| Analytics SQL | –ú–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è, –æ—Ç–¥–µ–ª—å–Ω—ã–π readonly replica |
| Health check | Lightweight check –±–µ–∑ getMe –ø—Ä–∏ —á–∞—Å—Ç—ã—Ö –ø—Ä–æ–≤–µ—Ä–∫–∞—Ö |

### 5.3 Observability

| –ß—Ç–æ –¥–æ–±–∞–≤–∏—Ç—å | –ó–∞—á–µ–º |
|--------------|-------|
| Prometheus metrics | request count, latency, errors |
| Distributed tracing | –û—Ç–ª–∞–¥–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π, —Ü–µ–ø–æ—á–∫–∏ –≤—ã–∑–æ–≤–æ–≤ |
| Alerting on revenue drop | –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ |
| Dashboard (Grafana) | –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –º–µ—Ç—Ä–∏–∫ |

---

## 6. –ß–µ–∫-–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º (–∫—Ä–∞—Ç–∫–æ)

```
[ ] alembic upgrade head
[ ] ALERT_CHAT_ID, ADMIN_IDS –∑–∞–¥–∞–Ω—ã
[ ] Webhook URL –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è YooKassa/CryptoBot (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è)
[ ] SENTRY_DSN (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
[ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å health: curl http://localhost:$PORT/health
[ ] –¢–µ—Å—Ç –ø–ª–∞—Ç–µ–∂–∞ (sandbox)
[ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å admin /admin
```
